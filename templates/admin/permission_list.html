{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}Manage Permissions{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-6 flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Permissions</h1>
                <p class="mt-1 text-sm text-gray-600">Configure access control for features and endpoints</p>
            </div>
            <div class="flex space-x-3">
                <a href="{% url 'rbac_dashboard' %}" 
                   class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    ‚Üê Back
                </a>
                <button onclick="openCreateModal()" 
                        class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                    + Create Permission
                </button>
            </div>
        </div>

        <!-- Permissions by Category -->
        {% regroup permissions by category as permission_groups %}
        {% for group in permission_groups %}
        <div class="bg-white shadow rounded-lg overflow-hidden mb-6">
            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900 uppercase">{{ group.grouper }}</h2>
            </div>
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Permission</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Codename</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Min Weight</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for perm in group.list %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">{{ perm.name }}</div>
                            <div class="text-xs text-gray-500">{{ perm.description|truncatewords:15 }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <code class="px-2 py-1 text-xs bg-gray-100 rounded">{{ perm.codename }}</code>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                {{ perm.min_role_weight }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if perm.is_active %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>
                            {% else %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Inactive</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick='openEditModal("{{ perm.id }}", "{{ perm.name|escapejs }}", "{{ perm.codename }}", "{{ perm.description|escapejs }}", {{ perm.min_role_weight }}, "{{ perm.category }}", {{ perm.is_active|lower }})'
                                    class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                            <button onclick='confirmDelete("{{ perm.id }}", "{{ perm.name|escapejs }}")'
                                    class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Create Modal (similar structure to role_list.html) -->
<div id="createModal" class="hidden fixed z-10 inset-0 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75" onclick="closeCreateModal()"></div>
        <div class="relative bg-white rounded-lg px-6 py-6 max-w-lg w-full">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Create New Permission</h3>
            <form method="POST" action="{% url 'permission_create' %}">
                {% csrf_token %}
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Permission Name</label>
                        <input type="text" name="name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Codename</label>
                        <input type="text" name="codename" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea name="description" rows="2" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Minimum Role Weight</label>
                        <input type="number" name="min_role_weight" required min="1" value="1" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Category</label>
                        <input type="text" name="category" value="general" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="mt-5 flex space-x-3">
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Create</button>
                    <button type="button" onclick="closeCreateModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="hidden fixed z-10 inset-0 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75" onclick="closeEditModal()"></div>
        <div class="relative bg-white rounded-lg px-6 py-6 max-w-lg w-full">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Edit Permission</h3>
            <form method="POST" id="editForm">
                {% csrf_token %}
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Permission Name</label>
                        <input type="text" name="name" id="edit_name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea name="description" id="edit_description" rows="2" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Minimum Role Weight</label>
                        <input type="number" name="min_role_weight" id="edit_min_role_weight" required min="1" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Category</label>
                        <input type="text" name="category" id="edit_category" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="is_active" id="edit_is_active" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="edit_is_active" class="ml-2 block text-sm text-gray-900">Active</label>
                    </div>
                </div>
                <div class="mt-5 flex space-x-3">
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save</button>
                    <button type="button" onclick="closeEditModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<form id="deleteForm" method="POST" style="display: none;">{% csrf_token %}</form>

<script>
function openCreateModal() { document.getElementById('createModal').classList.remove('hidden'); }
function closeCreateModal() { document.getElementById('createModal').classList.add('hidden'); }
function openEditModal(id, name, codename, description, minWeight, category, isActive) {
    document.getElementById('edit_name').value = name;
    document.getElementById('edit_description').value = description;
    document.getElementById('edit_min_role_weight').value = minWeight;
    document.getElementById('edit_category').value = category;
    document.getElementById('edit_is_active').checked = isActive;
    document.getElementById('editForm').action = `/rbac/permissions/${id}/edit/`;
    document.getElementById('editModal').classList.remove('hidden');
}
function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }
function confirmDelete(id, name) {
    if (confirm(`Delete permission "${name}"?`)) {
        document.getElementById('deleteForm').action = `/rbac/permissions/${id}/delete/`;
        document.getElementById('deleteForm').submit();
    }
}
</script>
{% endblock %}
