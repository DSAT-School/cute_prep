{% extends "base_dashboard.html" %}

{% block title %}Dashboard - DSAT SCHOOL{% endblock %}

{% block content %}
<div class="py-4">
    <div class="container mx-auto px-4">
        <!-- Welcome Section -->
        <div class="bg-gradient-to-r from-primary to-purple-700 rounded-lg shadow p-3 mb-4 text-white">
            <h1 class="text-lg font-bold mb-0.5">Welcome back, {{ user.get_full_name|default:user.username }}!</h1>
            <p class="text-xs opacity-90">Ready to ace your SAT? Let's continue your preparation journey.</p>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
            <!-- Total Practice Sessions -->
            <div class="bg-white rounded-lg shadow p-3 border-l-4 border-primary">
                <p class="text-gray-600 text-xs font-semibold mb-0.5">Sessions</p>
                <p class="text-xl font-bold text-gray-900">{{ total_sessions }}</p>
            </div>

            <!-- Total Questions -->
            <div class="bg-white rounded-lg shadow p-3 border-l-4 border-blue-500">
                <p class="text-gray-600 text-xs font-semibold mb-0.5">Questions</p>
                <p class="text-xl font-bold text-gray-900">{{ total_questions }}</p>
            </div>

            <!-- Accuracy -->
            <div class="bg-white rounded-lg shadow p-3 border-l-4 border-green-500">
                <p class="text-gray-600 text-xs font-semibold mb-0.5">Accuracy</p>
                <p class="text-xl font-bold {% if overall_accuracy >= 70 %}text-green-600{% elif overall_accuracy >= 50 %}text-yellow-600{% else %}text-orange-600{% endif %}">
                    {% if total_questions > 0 %}{{ overall_accuracy }}%{% else %}-{% endif %}
                </p>
            </div>

            <!-- Study Streak -->
            <div class="bg-white rounded-lg shadow p-3 border-l-4 border-secondary">
                <p class="text-gray-600 text-xs font-semibold mb-0.5">Streak</p>
                <p class="text-xl font-bold text-gray-900">{{ study_streak }} day{{ study_streak|pluralize }}</p>
            </div>
        </div>

        {% if estimated_score %}
        <!-- Estimated Score -->
        <div class="bg-gradient-to-r from-green-50 to-green-100 border-l-4 border-green-500 rounded-lg p-3 mb-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-green-800 mb-0.5">Estimated SAT Score</p>
                    <p class="text-2xl font-bold text-green-900">{{ estimated_score }}</p>
                    <p class="text-xs text-green-700 mt-0.5">Based on {{ total_questions }} question{{ total_questions|pluralize }}</p>
                </div>
                <div class="text-green-600">
                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
                    </svg>
                </div>
            </div>
        </div>
        {% endif %}

        {% if recommendations %}
        <!-- Recommended Practice (Priority) -->
        <div class="bg-white rounded-lg shadow p-4 mb-4">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-base font-bold text-gray-900">
                    <i class="fas fa-book-open text-primary"></i> Recommended Practice
                </h2>
                <span class="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full font-semibold">Focus Areas</span>
            </div>
            <div class="space-y-2">
                {% for rec in recommendations %}
                <div class="border border-gray-200 rounded-lg p-3 hover:border-primary hover:shadow-sm transition-all">
                    <div class="flex items-start justify-between gap-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold text-white bg-{{ rec.domain_code|lower }}-600 px-2 py-0.5 rounded" 
                                      style="background-color: {% if rec.domain_code == 'CAS' %}#9967b9{% elif rec.domain_code == 'EOI' %}#3b82f6{% elif rec.domain_code == 'SEC' %}#10b981{% else %}#f59e0b{% endif %}">
                                    {{ rec.domain_code }}
                                </span>
                                {% if rec.priority == 'high' %}
                                <span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded font-semibold">High Priority</span>
                                {% elif rec.priority == 'medium' %}
                                <span class="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded font-semibold">Needs Work</span>
                                {% else %}
                                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-semibold">New Topic</span>
                                {% endif %}
                            </div>
                            <h3 class="text-sm font-bold text-gray-900 mb-1">{{ rec.skill_name }}</h3>
                            <div class="flex items-center gap-3 text-xs text-gray-600">
                                {% if rec.accuracy is not None %}
                                <span>Current: <strong class="{% if rec.accuracy >= 70 %}text-green-600{% elif rec.accuracy >= 50 %}text-yellow-600{% else %}text-red-600{% endif %}">{{ rec.accuracy|floatformat:0 }}%</strong></span>
                                <span>Attempted: {{ rec.total_attempted }}</span>
                                {% else %}
                                <span class="text-gray-500">Not yet attempted</span>
                                {% endif %}
                                <span>Available: {{ rec.available_questions }}</span>
                            </div>
                        </div>
                        <a href="/practice/?domain={{ rec.domain_code }}&skill={{ rec.skill_code }}" 
                           class="bg-primary text-white px-3 py-1.5 text-xs rounded-lg font-semibold hover:bg-opacity-90 transition-all whitespace-nowrap">
                            Practice Now
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
            <!-- Weak Areas -->
            {% if weak_skills %}
            <div class="bg-white rounded-lg shadow p-4">
                <h2 class="text-base font-bold text-gray-900 mb-3">
                    <i class="fas fa-exclamation-triangle text-orange-500"></i> Areas Needing Improvement
                </h2>
                <div class="space-y-2">
                    {% for skill in weak_skills|slice:":3" %}
                    <div class="flex items-center justify-between p-2 bg-orange-50 border border-orange-200 rounded">
                        <div class="flex-1">
                            <p class="text-sm font-semibold text-gray-900">{{ skill.question__skill_name }}</p>
                            <p class="text-xs text-gray-600">{{ skill.total }} attempted • {{ skill.incorrect }} incorrect</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-orange-600">{{ skill.accuracy|floatformat:0 }}%</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Strong Areas -->
            {% if strong_skills %}
            <div class="bg-white rounded-lg shadow p-4">
                <h2 class="text-base font-bold text-gray-900 mb-3">
                    <i class="fas fa-star text-yellow-500"></i> Your Strengths
                </h2>
                <div class="space-y-2">
                    {% for skill in strong_skills %}
                    <div class="flex items-center justify-between p-2 bg-green-50 border border-green-200 rounded">
                        <div class="flex-1">
                            <p class="text-sm font-semibold text-gray-900">{{ skill.question__skill_name }}</p>
                            <p class="text-xs text-gray-600">{{ skill.total }} attempted • {{ skill.correct }} correct</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-green-600">{{ skill.accuracy|floatformat:0 }}%</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Recent Activity -->
        <div class="bg-white rounded-lg shadow p-4">
            <h2 class="text-base font-bold text-gray-900 mb-3">
                <i class="fas fa-chart-line text-primary"></i> Recent Practice Sessions
            </h2>
            {% if recent_sessions %}
            <div class="space-y-2">
                {% for session in recent_sessions %}
                <div class="border border-gray-200 rounded-lg p-3 hover:border-primary transition-all">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-white bg-primary px-2 py-0.5 rounded">{{ session.domain_code }}</span>
                            <span class="text-sm font-semibold text-gray-900">{{ session.skill_code }}</span>
                        </div>
                        <span class="text-xs text-gray-500">{{ session.completed_at|date:"M d, Y" }}</span>
                    </div>
                    <div class="grid grid-cols-3 gap-3 text-center">
                        <div>
                            <p class="text-xs text-gray-600">Questions</p>
                            <p class="text-sm font-bold text-gray-900">{{ session.total_questions }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600">Accuracy</p>
                            <p class="text-sm font-bold {% if session.accuracy_rate >= 70 %}text-green-600{% elif session.accuracy_rate >= 50 %}text-yellow-600{% else %}text-orange-600{% endif %}">
                                {{ session.accuracy_rate|floatformat:0 }}%
                            </p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600">Time</p>
                            <p class="text-sm font-bold text-gray-900">{{ session.total_time_seconds|floatformat:0 }}s</p>
                        </div>
                    </div>
                    <a href="/practice/results/{{ session.session_key }}/" class="block text-center text-xs text-primary font-semibold mt-2 hover:underline">
                        View Results →
                    </a>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-6">
                <svg class="w-10 h-10 text-gray-300 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <p class="text-gray-500 text-sm font-medium mb-1">No practice sessions yet</p>
                <p class="text-gray-400 text-xs mb-3">Start your first practice test to see insights here</p>
                <a href="/practice/" class="inline-block bg-primary text-white px-4 py-1.5 text-sm rounded-lg font-semibold hover:bg-opacity-90 transition-all">
                    Get Started
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
